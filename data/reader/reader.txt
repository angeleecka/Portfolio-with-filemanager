import React, { useState, useRef, useEffect } from 'react';
import { BookOpen, Type, AlignLeft, Save, FileText, Menu, X } from 'lucide-react';

const BookReaderMVP = () => {
  const [content, setContent] = useState('');
  const [pages, setPages] = useState([{ id: 1, text: '' }]);
  const [currentPage, setCurrentPage] = useState(0);
  const [isEditing, setIsEditing] = useState(true);
  const [leftPanelOpen, setLeftPanelOpen] = useState(false);
  const [rightPanelOpen, setRightPanelOpen] = useState(false);
  const [fontSize, setFontSize] = useState(16);
  const [lineHeight, setLineHeight] = useState(1.6);
  
  const leftPageRef = useRef(null);
  const rightPageRef = useRef(null);

  // Расчет количества символов, помещающихся на странице
  const calculatePageCapacity = (containerRef) => {
    if (!containerRef.current) return 0;
    
    const container = containerRef.current;
    const style = window.getComputedStyle(container);
    const height = container.offsetHeight;
    const paddingTop = parseFloat(style.paddingTop);
    const paddingBottom = parseFloat(style.paddingBottom);
    
    const availableHeight = height - paddingTop - paddingBottom;
    const lineHeightPx = fontSize * lineHeight;
    const linesPerPage = Math.floor(availableHeight / lineHeightPx);
    
    // Примерное количество символов в строке (зависит от ширины)
    const width = container.offsetWidth - parseFloat(style.paddingLeft) - parseFloat(style.paddingRight);
    const charsPerLine = Math.floor(width / (fontSize * 0.5)); // Приблизительная оценка
    
    return linesPerPage * charsPerLine;
  };

  // Разбивка текста на страницы
  const splitTextIntoPages = (text) => {
    if (!leftPageRef.current) return [{ id: 1, text }];
    
    const capacity = calculatePageCapacity(leftPageRef);
    if (capacity === 0) return [{ id: 1, text }];
    
    const newPages = [];
    let remainingText = text;
    let pageId = 1;
    
    while (remainingText.length > 0) {
      const pageText = remainingText.slice(0, capacity);
      newPages.push({ id: pageId++, text: pageText });
      remainingText = remainingText.slice(capacity);
    }
    
    if (newPages.length === 0) {
      newPages.push({ id: 1, text: '' });
    }
    
    return newPages;
  };

  const handleTextChange = (e) => {
    const newText = e.target.value;
    setContent(newText);
    const newPages = splitTextIntoPages(newText);
    setPages(newPages);
  };

  const goToNextPage = () => {
    if (currentPage < pages.length - 2) {
      setCurrentPage(currentPage + 2);
    }
  };

  const goToPrevPage = () => {
    if (currentPage > 0) {
      setCurrentPage(currentPage - 2);
    }
  };

  const handleSave = () => {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'book.txt';
    a.click();
    URL.revokeObjectURL(url);
  };

  useEffect(() => {
    // Пересчитываем страницы при изменении размера окна
    const handleResize = () => {
      if (content) {
        const newPages = splitTextIntoPages(content);
        setPages(newPages);
      }
    };
    
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [content, fontSize, lineHeight]);

  return (
    <div className="w-full h-screen bg-gradient-to-br from-amber-50 to-amber-100 flex flex-col overflow-hidden">
      {/* Шапка */}
      <header className="bg-amber-800 text-amber-50 px-4 py-3 flex items-center justify-between shadow-lg">
        <div className="flex items-center gap-3">
          <button 
            onClick={() => setLeftPanelOpen(!leftPanelOpen)}
            className="lg:hidden p-2 hover:bg-amber-700 rounded"
          >
            <Menu size={20} />
          </button>
          <BookOpen size={24} />
          <h1 className="text-xl font-serif">Моя Книга</h1>
        </div>
        <div className="flex items-center gap-2">
          <button 
            onClick={handleSave}
            className="p-2 hover:bg-amber-700 rounded flex items-center gap-2"
            title="Сохранить"
          >
            <Save size={20} />
            <span className="hidden sm:inline">Сохранить</span>
          </button>
          <button 
            onClick={() => setRightPanelOpen(!rightPanelOpen)}
            className="lg:hidden p-2 hover:bg-amber-700 rounded"
          >
            <Menu size={20} />
          </button>
        </div>
      </header>

      <div className="flex-1 flex overflow-hidden relative">
        {/* Левая панель инструментов */}
        <aside className={`
          ${leftPanelOpen ? 'translate-x-0' : '-translate-x-full'} 
          lg:translate-x-0 
          fixed lg:relative z-20 
          w-64 bg-amber-900 text-amber-50 p-4 
          transition-transform duration-300 
          h-full overflow-y-auto
        `}>
          <div className="flex justify-between items-center mb-4 lg:hidden">
            <h2 className="font-serif text-lg">Инструменты</h2>
            <button onClick={() => setLeftPanelOpen(false)}>
              <X size={20} />
            </button>
          </div>
          
          <h2 className="font-serif text-lg mb-4 hidden lg:block">Инструменты</h2>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm mb-2">Размер шрифта</label>
              <input 
                type="range" 
                min="12" 
                max="24" 
                value={fontSize}
                onChange={(e) => setFontSize(Number(e.target.value))}
                className="w-full"
              />
              <span className="text-xs">{fontSize}px</span>
            </div>
            
            <div>
              <label className="block text-sm mb-2">Межстрочный интервал</label>
              <input 
                type="range" 
                min="1.2" 
                max="2.0" 
                step="0.1"
                value={lineHeight}
                onChange={(e) => setLineHeight(Number(e.target.value))}
                className="w-full"
              />
              <span className="text-xs">{lineHeight.toFixed(1)}</span>
            </div>
            
            <button 
              onClick={() => setIsEditing(!isEditing)}
              className="w-full bg-amber-700 hover:bg-amber-600 px-4 py-2 rounded flex items-center gap-2"
            >
              <FileText size={16} />
              {isEditing ? 'Режим чтения' : 'Режим редактирования'}
            </button>
          </div>
        </aside>

        {/* Основная область книги */}
        <main className="flex-1 flex items-center justify-center p-4 lg:p-8 overflow-hidden">
          <div className="relative max-w-6xl w-full h-full flex items-center justify-center">
            {/* Развернутая книга - два разворота на десктопе */}
            <div className="hidden lg:flex gap-8 h-[80vh] perspective-1000">
              {/* Левая страница */}
              <div 
                ref={leftPageRef}
                className="w-96 bg-amber-50 shadow-2xl rounded-l-lg border-r border-amber-200 p-8 overflow-hidden"
                style={{
                  transform: 'rotateY(5deg)',
                  boxShadow: '-5px 5px 20px rgba(0,0,0,0.3)',
                }}
              >
                {isEditing && currentPage === 0 ? (
                  <textarea
                    value={content}
                    onChange={handleTextChange}
                    className="w-full h-full bg-transparent resize-none outline-none font-serif"
                    style={{ 
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }}
                    placeholder="Начните писать вашу историю..."
                  />
                ) : (
                  <div 
                    className="w-full h-full font-serif whitespace-pre-wrap overflow-hidden"
                    style={{ 
                      fontSize: `${fontSize}px`,
                      lineHeight: lineHeight
                    }}
                  >
                    {pages[currentPage]?.text || ''}
                  </div>
                )}
                <div className="absolute bottom-4 left-0 right-0 text-center text-amber-600 text-sm">
                  {currentPage + 1}
                </div>
              </div>
              
              {/* Правая страница */}
              <div 
                ref={rightPageRef}
                className="w-96 bg-amber-50 shadow-2xl rounded-r-lg border-l border-amber-200 p-8 overflow-hidden"
                style={{
                  transform: 'rotateY(-5deg)',
                  boxShadow: '5px 5px 20px rgba(0,0,0,0.3)',
                }}
              >
                <div 
                  className="w-full h-full font-serif whitespace-pre-wrap overflow-hidden"
                  style={{ 
                    fontSize: `${fontSize}px`,
                    lineHeight: lineHeight
                  }}
                >
                  {pages[currentPage + 1]?.text || ''}
                </div>
                <div className="absolute bottom-4 left-0 right-0 text-center text-amber-600 text-sm">
                  {currentPage + 2}
                </div>
              </div>
            </div>

            {/* Одна страница на мобильных */}
            <div className="lg:hidden w-full max-w-md h-[70vh] bg-amber-50 shadow-2xl rounded-lg p-6 overflow-hidden">
              {isEditing && currentPage === 0 ? (
                <textarea
                  value={content}
                  onChange={handleTextChange}
                  className="w-full h-full bg-transparent resize-none outline-none font-serif"
                  style={{ 
                    fontSize: `${fontSize}px`,
                    lineHeight: lineHeight
                  }}
                  placeholder="Начните писать вашу историю..."
                />
              ) : (
                <div 
                  className="w-full h-full font-serif whitespace-pre-wrap overflow-hidden"
                  style={{ 
                    fontSize: `${fontSize}px`,
                    lineHeight: lineHeight
                  }}
                >
                  {pages[currentPage]?.text || ''}
                </div>
              )}
              <div className="absolute bottom-4 left-0 right-0 text-center text-amber-600 text-sm">
                {currentPage + 1}
              </div>
            </div>

            {/* Навигация по страницам */}
            <button 
              onClick={goToPrevPage}
              disabled={currentPage === 0}
              className="absolute left-0 top-1/2 -translate-y-1/2 bg-amber-800 text-amber-50 p-3 rounded-r-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-amber-700 transition-colors"
            >
              ‹
            </button>
            <button 
              onClick={goToNextPage}
              disabled={currentPage >= pages.length - 2}
              className="absolute right-0 top-1/2 -translate-y-1/2 bg-amber-800 text-amber-50 p-3 rounded-l-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-amber-700 transition-colors"
            >
              ›
            </button>
          </div>
        </main>

        {/* Правая панель */}
        <aside className={`
          ${rightPanelOpen ? 'translate-x-0' : 'translate-x-full'} 
          lg:translate-x-0 
          fixed lg:relative z-20 right-0
          w-64 bg-amber-900 text-amber-50 p-4 
          transition-transform duration-300 
          h-full overflow-y-auto
        `}>
          <div className="flex justify-between items-center mb-4 lg:hidden">
            <h2 className="font-serif text-lg">Информация</h2>
            <button onClick={() => setRightPanelOpen(false)}>
              <X size={20} />
            </button>
          </div>
          
          <h2 className="font-serif text-lg mb-4 hidden lg:block">Информация</h2>
          
          <div className="space-y-4 text-sm">
            <div>
              <p className="text-amber-300 mb-1">Страниц:</p>
              <p className="text-xl font-bold">{pages.length}</p>
            </div>
            <div>
              <p className="text-amber-300 mb-1">Символов:</p>
              <p className="text-xl font-bold">{content.length}</p>
            </div>
            <div>
              <p className="text-amber-300 mb-1">Слов:</p>
              <p className="text-xl font-bold">
                {content.trim() ? content.trim().split(/\s+/).length : 0}
              </p>
            </div>
          </div>
        </aside>
      </div>

      {/* Футер */}
      <footer className="bg-amber-800 text-amber-50 px-4 py-2 text-center text-sm">
        Страница {currentPage + 1} - {currentPage + 2} из {pages.length}
      </footer>
    </div>
  );
};

export default BookReaderMVP;

===============================================

Отличная идея! Создам для вас MVP читалки-редактора книг с адаптивным дизайном. Начнем с базовой структуры и визуального макета.Отлично! Я создал базовый MVP вашей читалки-редактора книг. Вот что уже реализовано:

## Реализованные функции:

### Визуальный дизайн:
- **Развернутая книга** на десктопе (два разворота с 3D-эффектом)
- **Одностраничный режим** на мобильных устройствах
- Адаптивные боковые панели, которые выезжают/заезжают на мобильных

### Инструменты:
- Регулировка размера шрифта (12-24px)
- Настройка межстрочного интервала (1.2-2.0)
- Переключение между режимом редактирования и чтения
- Сохранение текста в файл

### Функциональность:
- Автоматическое разбиение текста на страницы при вводе
- Навигация между страницами (стрелки влево/вправо)
- Счетчик страниц, символов и слов
- Адаптивный дизайн для разных устройств

## Следующие шаги для развития:

1. **Улучшенная пагинация** - более точный алгоритм разбивки с учетом слов (не разрывать слова между страницами)
2. **Закладки** - горизонтальные (на абзацы) и вертикальные (на страницы)
3. **Заметки на полях** - возможность добавлять комментарии к фрагментам текста
4. **Открытие готовых текстов** - импорт файлов для чтения
5. **Система персонажей и сюжетных линий** - отслеживание связей

Что бы вы хотели добавить в первую очередь? Может, начнем с улучшения пагинации или добавим закладки?